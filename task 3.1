#include <Wire.h>
#include <BH1750.h>
#include <WiFiNINA.h>
#include <ArduinoHttpClient.h>

// WiFi credentials
char ssid[] = "Iqoo 13";
char pass[] = "fitgirl12";

// IFTTT webhook details
const char server[] = "maker.ifttt.com";
String eventOn  = "terrarium";
String eventOff = "terrarium"; // Event when light drops below threshold
String key      = "oyO6J6ceD7GDLjp3l1EjlmyvIVIb_TzOnsv4_nqzLl5";  
int port = 80;

BH1750 lightMeter;
WiFiClient wifi;
HttpClient client = HttpClient(wifi, server, port);

bool sunlightOn = false;
int thresholdLux = 1000;    // adjust depending on room

void setup() {
  Serial.begin(9600);
  Wire.begin();

  if (lightMeter.begin(BH1750::CONTINUOUS_HIGH_RES_MODE)) {
    Serial.println("BH1750 ready");
  } else {
    Serial.println("BH1750 not found. Check wiring!");
    while (1);
  }

  while (WiFi.begin(ssid, pass) != WL_CONNECTED) {
    Serial.println("Connecting to WiFi...");
    delay(1000);
  }
  Serial.println("Connected to WiFi");
}

void loop() {
  float lux = lightMeter.readLightLevel();
  Serial.print("Light: ");
  Serial.print(lux);
  Serial.println(" lux");

  if (lux > thresholdLux && !sunlightOn) {
    triggerIFTTT(eventOn, lux);
    sunlightOn = true;
  }
  else if (lux <= thresholdLux && sunlightOn) {
    triggerIFTTT(eventOff, lux);
    sunlightOn = false;
  }

  delay(5000);
}

void triggerIFTTT(String eventName, float lux) {
  String url = "/trigger/" + eventName + "/with/key/" + key + "?value1=" + String(lux);
  client.get(url);

  int statusCode = client.responseStatusCode();
  String response = client.responseBody();

  Serial.print("Triggered IFTTT event: ");
  Serial.print(eventName);
  Serial.print(" | Lux: ");
  Serial.println(lux);

  Serial.print("HTTP Status: ");
  Serial.println(statusCode);
  Serial.print("Response: ");
  Serial.println(response);
}
